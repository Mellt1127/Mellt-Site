<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
 <title>Adventure of Spark</title>
    <link rel="icon" type="image/png" href="texture/AoS.png">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --ui-bg: rgba(0,0,0,.65);
    --ui-fg: #fff; }
  *{box-sizing:border-box}
  body{margin:0;overflow:hidden;background:#9fd3ff;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  canvas{display:block;width:100vw;height:100vh}
  #hud{position:fixed;top:8px;left:8px;color:var(--ui-fg);font-size:.75rem;z-index:10;text-shadow:1px 1px 0 #000}
  #dayNight{position:fixed;top:8px;left:50%;transform:translateX(-50%);background:var(--ui-bg);color:var(--ui-fg);padding:6px 10px;border-radius:6px;font-size:.7rem;z-index:10}
  #buttons{position:fixed;top:8px;right:8px;display:flex;gap:8px;z-index:12}
  .btn{background:var(--ui-bg);color:var(--ui-fg);border:none;border-radius:6px;padding:6px 10px;font-size:.7rem;cursor:pointer}
  #tooltip{position:fixed;bottom:92px;left:50%;transform:translateX(-50%);background:var(--ui-bg);color:#ffef8a;padding:8px 12px;border-radius:6px;font-size:.78rem;opacity:0;pointer-events:none;transition:opacity .2s, transform .2s;z-index:20}
  #warn{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:var(--ui-bg);color:#ffd0d0;padding:6px 10px;border-radius:6px;font-size:.72rem;opacity:0;pointer-events:none;transition:opacity .2s;z-index:20}
  #help{position:fixed;top:48px;right:8px;background:var(--ui-bg);color:var(--ui-fg);padding:10px;border-radius:10px;font-size:.7rem;display:none;z-index:15;max-width:min(380px,90vw);line-height:1.6}
  #inventory,#tools{position:fixed;bottom:18px;display:flex;gap:8px;background:var(--ui-bg);padding:8px;border-radius:10px;z-index:12}
  #inventory{left:50%;transform:translateX(-50%)}
  #tools{right:10px}
  .slot{width:42px;height:42px;border:2px solid #555;background:#222 center/cover no-repeat;position:relative;cursor:pointer}
  .slot.active{border-color:gold;box-shadow:0 0 8px gold}
  .count{position:absolute;bottom:1px;right:2px;font-size:.6rem;color:#fff;text-shadow:1px 1px 0 #000}
  #craftBtn{position:fixed;right:10px;bottom:120px;z-index:12}
  #craftMenu{position:fixed;right:10px;bottom:170px;display:none;flex-direction:column;gap:8px;background:var(--ui-bg);padding:12px;border-radius:10px;z-index:15;width:280px}
  .recipe{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.05);padding:8px;border-radius:8px;font-size:.7rem;color:#fff;cursor:pointer}
  .recipe:hover{background:rgba(255,255,255,.12)}
  .recipe img{width:26px;height:26px;image-rendering:pixelated}
  #blockName{position:fixed;background:var(--ui-bg);color:#fff;padding:6px 8px;border-radius:6px;font-size:.72rem;pointer-events:none;transform:translate(-50%,-100%);display:none;z-index:30}
</style>
</head>
<body>
  <div id="hud"></div>
  <div id="dayNight">‚òÄÔ∏è–î–µ–Ω—å‚òÄÔ∏è</div>
  <div id="buttons">
    <button id="helpBtn" class="btn">‚ùî–ü–æ–¥—Å–∫–∞–∑–∫–∏‚ùî</button>
    <button id="audioBtn" class="btn">üîä–ó–≤—É–∫üîä</button>
    <button id="craftBtn" class="btn">üß∞–ö—Ä–∞—Ñ—Çüß∞</button>
  </div>
  <div id="help">
  WASD/–°—Ç—Ä–µ–ª–∫–∏ ‚Äî –•–æ–¥—å–±–∞/–ü—Ä—ã–∂–æ–∫<br>
    –õ–ö–ú ‚Äî —Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫ ‚Ä¢ –ü–ö–ú ‚Äî –ª–æ–º–∞—Ç—å –±–ª–æ–∫ (–¥–∏—Å—Ç–∞–Ω—Ü–∏—è ‚â§ 5 –±–ª–æ–∫–æ–≤)<br>
    1‚Äì9 ‚Äî –±—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Å–ª–æ—Ç–∞ ‚Ä¢ R ‚Äî –æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å –∫—Ä–∞—Ñ—Ç<br>
    –†—è–¥–æ–º —Å –≤–µ—Ä—Å—Ç–∞–∫–æ–º ‚Äî –∫—Ä–∞—Ñ—Ç –ø–µ—á–∏ ‚Ä¢ –†—è–¥–æ–º —Å –ø–µ—á—å—é ‚Äî –ø–µ—Ä–µ–ø–ª–∞–≤–∫–∞ –∂–µ–ª–µ–∑–∞<br>
    –§–∞–∫–µ–ª—ã –∏ –ø–µ—á—å —Å–≤–µ—Ç—è—Ç –Ω–æ—á—å—é <br>
    –í –≤–æ–∑–¥—É—Ö–µ –±–ª–æ–∫ –Ω–µ —Å—Ç–∞–≤–∏—Ç—Å—è ‚Äî —Ç–æ–ª—å–∫–æ —Ä—è–¥–æ–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º!
  </div>
  <div id="tooltip"></div>
  <div id="warn"></div>
  <canvas id="cv"></canvas>
  <div id="inventory"></div>
  <div id="tools"></div>
  <div id="blockName"></div>
  <!-- –ê—É–¥–∏–æ -->
  <audio id="jumpS"><source src="sound/jump.wav" type="audio/wav"></audio>
  <audio id="breakS"><source src="sound/break.wav" type="audio/wav"></audio>
  <audio id="walkS"><source src="sound/walk.wav" type="audio/wav"></audio>
  <audio id="bgm" loop><source src="sound/background.mp3" type="audio/mp3"></audio>
<script>
/* =================== –ö–û–ù–°–¢–ê–ù–¢–´ =================== */
const TILE = 42;
const WORLD_W = 1000;
const WORLD_H = 100;

const PLAYER_W = TILE*0.8, PLAYER_H = TILE*1.8;
// CAMERA_SMOOTH = 1 -> –∫–∞–º–µ—Ä–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä—è–º–æ –Ω–∞ –∏–≥—Ä–æ–∫–µ
const CAMERA_SMOOTH = 1.0;

const DAY_LEN = 60;      // —Å–µ–∫
const NIGHT_LEN = 60;      // —Å–µ–∫
const TRANSITION = 3;    // —Å–µ–∫

const BLEND = 4;
const PLACE_DIST = TILE*5;
const BREAK_DIST = TILE*5;
const WALK_SOUND_COOLDOWN = 3000; // –º—Å

/* =================== –ë–õ–û–ö–ò =================== */
const BLOCKS = {
  GRASS:0, DIRT:1, STONE:2, WOOD:3, LEAVES:4, FLOWER:5, PLANKS:6, BEDROCK:7, AIR:8, TALL_GRASS:9,
  MOON_ROCK:10, MOON_FLOWER:11, COAL:12, IRON:13, CAVE_AIR:14, WORKBENCH:15, COAL_ITEM:16,
  SNOW:17, SNOW_GRASS:18, SNOW_DIRT:19, ICE:20, WOOD_BG:21,
  SAND:22, DEAD_BUSH:23, CACTUS:24, FURNACE_OFF:25, FURNACE_ON:26, TORCH:27, IRON_INGOT:28,
  SNOW_TALL_GRASS:29, SNOW_FLOWER:30, HARD_SAND:31
};

const BLOCK_NAMES = {
  [BLOCKS.GRASS]:"–¢—Ä–∞–≤—è–Ω–æ–π –±–ª–æ–∫",[BLOCKS.DIRT]:"–ó–µ–º–ª—è",[BLOCKS.STONE]:"–ö–∞–º–µ–Ω—å",
  [BLOCKS.WOOD]:"–ë—Ä–µ–≤–Ω–æ",[BLOCKS.LEAVES]:"–õ–∏—Å—Ç–≤–∞",[BLOCKS.FLOWER]:"–¶–≤–µ—Ç–æ–∫",
  [BLOCKS.PLANKS]:"–î–æ—Å–∫–∞",[BLOCKS.BEDROCK]:"–ë–µ–¥—Ä–æ–∫",[BLOCKS.TALL_GRASS]:"–¢—Ä–∞–≤–∏–Ω–∫–∞",
  [BLOCKS.MOON_ROCK]:"–õ—É–Ω–Ω—ã–π –∫–∞–º–µ–Ω—å",[BLOCKS.MOON_FLOWER]:"–õ—É–Ω–Ω—ã–π —Ü–≤–µ—Ç–æ–∫",
  [BLOCKS.COAL]:"–£–≥–æ–ª—å–Ω–∞—è —Ä—É–¥–∞",[BLOCKS.IRON]:"–ñ–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞",
  [BLOCKS.CAVE_AIR]:"–ü–µ—â–µ—Ä–Ω—ã–π –≤–æ–∑–¥—É—Ö",[BLOCKS.WORKBENCH]:"–í–µ—Ä—Å—Ç–∞–∫",
  [BLOCKS.COAL_ITEM]:"–£–≥–æ–ª—å",[BLOCKS.SNOW]:"–°–Ω–µ–≥",[BLOCKS.SNOW_GRASS]:"–°–Ω–µ–∂–Ω–∞—è —Ç—Ä–∞–≤–∞",
  [BLOCKS.SNOW_DIRT]:"–°–Ω–µ–∂–Ω–∞—è –∑–µ–º–ª—è",[BLOCKS.ICE]:"–õ—ë–¥",[BLOCKS.WOOD_BG]:"–î–µ—Ä–µ–≤–æ (—Ñ–æ–Ω)",
  [BLOCKS.SAND]:"–ü–µ—Å–æ–∫",[BLOCKS.DEAD_BUSH]:"–ú—ë—Ä—Ç–≤—ã–π –∫—É—Å—Ç",[BLOCKS.CACTUS]:"–ö–∞–∫—Ç—É—Å",
  [BLOCKS.FURNACE_OFF]:"–ü–µ—á—å",[BLOCKS.FURNACE_ON]:"–ü–µ—á—å (–≥–æ—Ä–∏—Ç)",[BLOCKS.TORCH]:"–§–∞–∫–µ–ª",
  [BLOCKS.IRON_INGOT]:"–ñ–µ–ª–µ–∑–Ω—ã–π —Å–ª–∏—Ç–æ–∫",[BLOCKS.SNOW_TALL_GRASS]:"–°–Ω–µ–∂–Ω–∞—è —Ç—Ä–∞–≤–∏–Ω–∫–∞",
  [BLOCKS.SNOW_FLOWER]:"–°–Ω–µ–∂–Ω—ã–π —Ü–≤–µ—Ç–æ–∫", [BLOCKS.HARD_SAND]:"–ü—Ä–æ—á–Ω—ã–π –ø–µ—Å–æ–∫"
};

// –ü–†–û–•–û–î–ò–ú–´–ï –ë–õ–û–ö–ò
function isSolid(b){
  return !(
    b===BLOCKS.AIR || b===BLOCKS.CAVE_AIR || b===BLOCKS.FLOWER || b===BLOCKS.TALL_GRASS ||
    b===BLOCKS.SNOW_TALL_GRASS || b===BLOCKS.MOON_FLOWER || b===BLOCKS.LEAVES ||
    b===BLOCKS.SNOW || b===BLOCKS.WOOD_BG || b===BLOCKS.DEAD_BUSH || b===BLOCKS.CACTUS || b===BLOCKS.SNOW || 
    b===BLOCKS.SNOW_FLOWER
  );
}
function isPassable(b){ return !isSolid(b); }

/* =================== –¢–ï–ö–°–¢–£–†–´ =================== */
const TEX = {
  player_stand:"texture/player_stand.png",
  player_right:"texture/player_right.png",
  player_left:"texture/player_left.png",
  blocks:{}
};
TEX.blocks[BLOCKS.GRASS]="texture/grass.png";
TEX.blocks[BLOCKS.DIRT]="texture/dirt.png";
TEX.blocks[BLOCKS.STONE]="texture/stone.png";
TEX.blocks[BLOCKS.WOOD]="texture/wood.png";
TEX.blocks[BLOCKS.WOOD_BG]="texture/wood.png";
TEX.blocks[BLOCKS.LEAVES]="texture/leaves.png";
TEX.blocks[BLOCKS.FLOWER]="texture/flower.png";
TEX.blocks[BLOCKS.PLANKS]="texture/planks.png";
TEX.blocks[BLOCKS.BEDROCK]="texture/bedrock.png";
TEX.blocks[BLOCKS.TALL_GRASS]="texture/tall_grass.png";
TEX.blocks[BLOCKS.MOON_ROCK]="texture/moon_rock.png";
TEX.blocks[BLOCKS.MOON_FLOWER]="texture/moon_flower.png";
TEX.blocks[BLOCKS.COAL]="texture/coal.png";
TEX.blocks[BLOCKS.IRON]="texture/iron.png";
TEX.blocks[BLOCKS.WORKBENCH]="texture/workbench.png";
TEX.blocks[BLOCKS.SNOW]="texture/snow.png";
TEX.blocks[BLOCKS.SNOW_GRASS]="texture/snow_grass.png";
TEX.blocks[BLOCKS.SNOW_DIRT]="texture/snow_dirt.png";
TEX.blocks[BLOCKS.SNOW_TALL_GRASS]="texture/snow_tall_grass.png";
TEX.blocks[BLOCKS.ICE]="texture/ice.png";
TEX.blocks[BLOCKS.SAND]="texture/sand.png";
TEX.blocks[BLOCKS.DEAD_BUSH]="texture/dead_bush.png";
TEX.blocks[BLOCKS.CACTUS]="texture/cactus.png";
TEX.blocks[BLOCKS.FURNACE_OFF]="texture/furnace.png";
TEX.blocks[BLOCKS.FURNACE_ON]="texture/furnace_on1.png";
TEX.blocks[BLOCKS.TORCH]="texture/torch.png";
TEX.blocks[BLOCKS.SNOW_FLOWER]="texture/snow_flower.png";
TEX.blocks[BLOCKS.HARD_SAND]="texture/hard_sand.png";

const ITEMS = {
  axe:"texture/axe.png",
  pickaxe:"texture/pickaxe.png",
  shovel:"texture/shovel.png",
  coal:"texture/coal_item.png",
  iron_ingot:"texture/iron_ingot.png",
};

/* =================== DOM =================== */
const cv = document.getElementById('cv');
const cx = cv.getContext('2d');
const inventoryDiv = document.getElementById('inventory');
const toolsDiv = document.getElementById('tools');
const tooltip = document.getElementById('tooltip');
const warn = document.getElementById('warn');
const help = document.getElementById('help');
const helpBtn = document.getElementById('helpBtn');
const audioBtn = document.getElementById('audioBtn');
const craftBtn = document.getElementById('craftBtn');
const dayNightDiv = document.getElementById('dayNight');
const blockNameDiv = document.getElementById('blockName');
const jumpS = document.getElementById('jumpS');
const breakS = document.getElementById('breakS');
const walkS = document.getElementById('walkS');
const bgm = document.getElementById('bgm');

/* =================== –ò–ì–†–û–ö/–ú–ò–†/–°–û–°–¢–û–Ø–ù–ò–Ø =================== */
const player = {
  x: 0, y: 0, w: PLAYER_W, h: PLAYER_H,
  vx:0, vy:0, speed:3.6, jump:-11,
  onGround:false, onIce:false, facing:1,
  walking:false, frame:0, frameT:0, frameInterval:160,
  selectedBlock: BLOCKS.AIR,
  inv:{}, tools:{axe:false,pickaxe:false,shovel:false}
};
let world = [];
let cam = {x:0,y:0};
let textures = {};
let lastTime = 0;
let audioEnabled = false;
let showHelp = false;
let spawn = {x:0,y:0};
let inputTargetVX = 0;
let lastWalkSound = 0;

/* –î–µ–Ω—å/–Ω–æ—á—å */
let timeSec = 0;
let isDay = true;
let trans = 1;

/* —Å–Ω–µ–≥ */
let snowStart=0, snowEnd=0;
let desertStart=0, desertEnd=0;
let snowflakes=[], snowing=false, snowTimer=0;

/* –ü–µ—á—å / –æ—Å–≤–µ—â–µ–Ω–∏–µ */
let furnaceAnimTimer = 0;
let furnaceAnimState = 0;
let burningFurnaces = new Map();
let torches = new Set();

/* –ö—Ä–∞—Ñ—Ç –º–µ–Ω—é */
const craftMenu = document.createElement('div');
craftMenu.id = 'craftMenu';
document.body.appendChild(craftMenu);

/* =================== –£–¢–ò–õ–ò–¢–´ =================== */
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function tileAt(px,py){
  const gx = Math.floor(px/TILE), gy = Math.floor(py/TILE);
  if(gx<0||gx>=WORLD_W||gy<0||gy>=WORLD_H) return BLOCKS.AIR;
  return world[gy][gx];
}
function inRange(x1,y1,x2,y2,dist){
  const dx = x1-x2, dy = y1-y2;
  return Math.hypot(dx,dy) <= dist;
}
function addInv(id, n=1){
  if(!(id in player.inv)) player.inv[id]=0;
  player.inv[id]+=n; refreshInventory();
}
function useInv(id, n=1){
  if((player.inv[id]||0)>=n){ player.inv[id]-=n; if(player.inv[id]<0) player.inv[id]=0; refreshInventory(); return true; }
  return false;
}
function showTip(msg, t=1400){
  tooltip.textContent = msg;
  tooltip.style.opacity = 1;
  tooltip.style.transform = "translateX(-50%) translateY(0)";
  clearTimeout(showTip._to);
  showTip._to = setTimeout(()=>{ tooltip.style.opacity=0; tooltip.style.transform="translateX(-50%) translateY(6px)"; }, t);
}
function showWarn(msg, t=1400){
  warn.textContent = msg;
  warn.style.opacity = 1;
  clearTimeout(showWarn._to);
  showWarn._to = setTimeout(()=>{ warn.style.opacity=0; }, t);
}

/* canPlaceAt –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {ok, reason} */
function canPlaceAt(gx,gy){
  if(gx<0||gx>=WORLD_W||gy<0||gy>=WORLD_H) return {ok:false,reason:'–ó–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –º–∏—Ä–∞'};
  const x = gx*TILE, y = gy*TILE;
  const overlap = !(x+TILE < player.x || x > player.x+player.w || y+TILE < player.y || y > player.y+player.h);
  if(overlap) return {ok:false,reason:'self'}; // —Å—Ç–∞–≤—è—Ç –≤ —Å–µ–±—è
  // –æ–ø–æ—Ä–∞ ‚Äî —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–æ—Å–µ–¥–Ω–∏–π –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –ù–ï —è–≤–ª—è–µ—Ç—Å—è –ø—É—Å—Ç—ã–º/—Ä–∞—Å—Ç–µ–Ω–∏–µ–º/—Å–Ω–µ–≥–æ–º
  const neigh = [[gx+1,gy],[gx-1,gy],[gx,gy+1],[gx,gy-1]];
  let ok=false;
  for(const [nx,ny] of neigh){
    if(nx<0||nx>=WORLD_W||ny<0||ny>=WORLD_H) continue;
    const b=world[ny][nx];
    if(b!==BLOCKS.AIR && b!==BLOCKS.CAVE_AIR && b!==BLOCKS.FLOWER && b!==BLOCKS.TALL_GRASS &&
       b!==BLOCKS.SNOW_TALL_GRASS && b!==BLOCKS.MOON_FLOWER && b!==BLOCKS.SNOW && b!==BLOCKS.LEAVES){
      ok=true;break;
    }
  }
  if(!ok) return {ok:false,reason:'air'};
  return {ok:true,reason:null};
}

/* =================== –ò–ù–í–ï–ù–¢–ê–†–¨/–ò–ù–°–¢–†–£–ú–ï–ù–¢–´ =================== */
function resetInventory(){ player.inv={}; }
function refreshInventory(){
  inventoryDiv.innerHTML='';
  const order = [
    BLOCKS.GRASS,BLOCKS.DIRT,BLOCKS.STONE,BLOCKS.SAND,BLOCKS.SNOW,BLOCKS.ICE,BLOCKS.PLANKS,BLOCKS.WOOD,
    BLOCKS.LEAVES,BLOCKS.FLOWER,BLOCKS.TALL_GRASS,BLOCKS.SNOW_TALL_GRASS,BLOCKS.MOON_ROCK,BLOCKS.MOON_FLOWER,
    BLOCKS.COAL_ITEM,BLOCKS.IRON,BLOCKS.IRON_INGOT,BLOCKS.WORKBENCH,BLOCKS.FURNACE_OFF,BLOCKS.TORCH, BLOCKS.SNOW_DIRT, BLOCKS.SNOW_GRASS, 
    BLOCKS.DEAD_BUSH,BLOCKS.CACTUS,BLOCKS.SNOW_FLOWER
  ];
  for(const id of order){
    const cnt = player.inv[id]||0;
    if(cnt>0){
      const d=document.createElement('div');
      d.className='slot';
      const bg = (id===BLOCKS.COAL_ITEM)? ITEMS.coal : (TEX.blocks[id]?TEX.blocks[id]:'');
      if(bg) d.style.backgroundImage = `url(${bg})`;
      const s=document.createElement('span');
      s.className='count'; s.textContent=cnt;
      d.appendChild(s);
      d.onclick=()=>{
        document.querySelectorAll('.slot').forEach(e=>e.classList.remove('active'));
        d.classList.add('active');
        player.selectedBlock = id;
        player.tools.axe = player.tools.pickaxe = player.tools.shovel = false;
      };
      d.onmouseenter=()=>showBlockName(BLOCK_NAMES[id]||'–ë–ª–æ–∫', d);
      d.onmouseleave=hideBlockName;
      inventoryDiv.appendChild(d);
    }
  }
}
function initTools(){
  toolsDiv.innerHTML='';
  const list=[{id:'axe',name:'–¢–æ–ø–æ—Ä'},{id:'pickaxe',name:'–ö–∏—Ä–∫–∞'},{id:'shovel',name:'–õ–æ–ø–∞—Ç–∞'}];
  for(const t of list){
    const d=document.createElement('div');
    d.className='slot';
    d.style.backgroundImage=`url(${ITEMS[t.id]})`;
    d.onclick=()=>{
      document.querySelectorAll('.slot').forEach(e=>e.classList.remove('active'));
      d.classList.add('active');
      player.tools.axe = t.id==='axe';
      player.tools.pickaxe = t.id==='pickaxe';
      player.tools.shovel = t.id==='shovel';
      player.selectedBlock = BLOCKS.AIR;
    };
    d.onmouseenter=()=>showBlockName(t.name, d);
    d.onmouseleave=hideBlockName;
    toolsDiv.appendChild(d);
  }
}
function showBlockName(name, elem){
  blockNameDiv.textContent = name;
  blockNameDiv.style.display='block';
  const r = elem.getBoundingClientRect();
  blockNameDiv.style.left = (r.left + r.width/2)+'px';
  blockNameDiv.style.top = (r.top - 8)+'px';
}
function hideBlockName(){ blockNameDiv.style.display='none'; }

/* =================== –ú–ò–†: –ì–ï–ù–ï–†–ê–¶–ò–Ø =================== */
function genWorld(){
  world = Array.from({length:WORLD_H},()=>Array(WORLD_W).fill(BLOCKS.AIR));

  snowStart = Math.floor(Math.random()*(WORLD_W-140))+40;
  snowEnd = snowStart + Math.floor(Math.random()*80)+50;

  do{
    desertStart = Math.floor(Math.random()*(WORLD_W-140))+40;
    desertEnd = desertStart + Math.floor(Math.random()*80)+50;
  } while(!(desertEnd < snowStart-20 || desertStart > snowEnd+20));

  for(let x=0;x<WORLD_W;x++){
    const snowF = blendFactor(x, snowStart, snowEnd);
    const desertF = blendFactor(x, desertStart, desertEnd);
    const baseY = Math.floor(WORLD_H/2 + Math.sin(x/22)*3 + Math.random()*2);

    for(let y=baseY;y<WORLD_H;y++){
      const deep = y-baseY;
    if(y===baseY){
    if(snowF>0.6){
        world[y][x] = BLOCKS.SNOW_GRASS;

        // ‚ùÑÔ∏è –î–û–ë–ê–í–õ–Ø–ï–ú –°–ù–ï–ì –°–í–ï–†–•–£// –ë–∏–æ–º—ã
        if (Math.random() > 0.50 && y - 1 >= 0) {
            world[y - 1][x] = BLOCKS.SNOW;
        }

        if (Math.random() > 0.92 && y - 3 >= 0)
            world[y - 1][x] = BLOCKS.ICE;

        if(Math.random()>0.75 && y-1>=0) 
            world[y-1][x] = BLOCKS.SNOW_TALL_GRASS;

            if (Math.random() > 0.80 && y - 1 >= 0) {
    world[y - 1][x] = BLOCKS.SNOW_FLOWER;
}

        }else if(desertF>0.6){
          world[y][x] = BLOCKS.SAND;
          if(Math.random()>0.85 && y-1>=0) world[y-1][x] = Math.random()>0.55?BLOCKS.DEAD_BUSH:BLOCKS.CACTUS;
        }else{
          world[y][x] = BLOCKS.GRASS;
          if(Math.random()>0.65 && y-1>=0) world[y-1][x] = BLOCKS.TALL_GRASS;
          if(Math.random()>0.90 && y-1>=0) world[y-1][x] = Math.random()>0.85?BLOCKS.MOON_FLOWER:BLOCKS.FLOWER;
        }
      } else if(deep<3){
        if(snowF>0.6) world[y][x] = BLOCKS.SNOW_DIRT;
        else if(desertF>0.6) world[y][x] = BLOCKS.SAND;
        else world[y][x] = BLOCKS.DIRT;
      } else if(y>=WORLD_H-1-Math.floor(Math.random()*3)){
        world[y][x]=BLOCKS.BEDROCK;
      } else {
        if(Math.random()>0.7) world[y][x] = Math.random()>0.97?BLOCKS.MOON_ROCK:BLOCKS.STONE;
        else world[y][x] = (snowF>0.6?BLOCKS.SNOW_DIRT:(desertF>0.6?BLOCKS.SAND:BLOCKS.DIRT));
      }
    }
    
    function blendFactor(x, start, end){
    if (x < start - 20 || x > end + 20) return 0;
    let dist = (x - start) / (end - start);
    return Math.max(0, Math.min(1, dist));
}
    // –¥–µ—Ä–µ–≤—å—è —Ñ–æ–Ω–æ–≤—ã–µ
if(Math.random() > 0.975 && blendFactor(x, desertStart, desertEnd) < 0.5){
  // –ò—â–µ–º –∏–º–µ–Ω–Ω–æ GRASS –∏–ª–∏ SNOW_GRASS
  function findGrass(x){
    for(let y = 0; y < WORLD_H; y++){
      if(world[y][x] === BLOCKS.GRASS || world[y][x] === BLOCKS.SNOW_GRASS){
        return y;
      }
    }
    return null;
  }
  const tx = x;
  const groundY = findGrass(x);
  if(groundY === null) return;  // –Ω–µ—Ç —Ç—Ä–∞–≤—ã ‚Äî –Ω–µ—Ç –¥–µ—Ä–µ–≤–∞
  const ty = groundY - 1;  // —Å–≤–µ—Ä—Ö—É –¥–µ—Ä–µ–≤–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å—Ç–≤–æ–ª
  const h = Math.floor(Math.random() * 4) + 3; // 3..6 –≤—ã—Å–æ—Ç–∞
  // ===== –°–¢–í–û–õ =====
  for(let yy = ty; yy > ty - h; yy--){
    if(yy >= 0) world[yy][tx] = BLOCKS.WOOD_BG;
  }


     
    const r = 3; // —Ä–∞–¥–∏—É—Å –∫—Ä–æ–Ω—ã
    const cx = tx;
    const cy = ty - h; 
    for(let yy = cy - r; yy <= cy + r; yy++){
    for(let xx = cx - r; xx <= cx + r; xx++){
      if(xx >= 0 && xx < WORLD_W && yy >= 0 && world[yy][xx] === BLOCKS.AIR){
        const dx = xx - cx;
        const dy = yy - cy;
        const dist = Math.sqrt(dx*dx + dy*dy * 1.2); 
        if(dist <= r - 0.1){ // –Ω–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∞–µ–º —Ä–∞–¥–∏—É—Å, —á—Ç–æ–±—ã —É–≥–ª—ã —Å—Ä–µ–∑–∞—Ç—å
          if(Math.random() > 0.01) world[yy][xx] = BLOCKS.LEAVES; // –ø–æ—á—Ç–∏ –±–µ–∑ –¥—ã—Ä–æ–∫
        }
      }
    } 
  }
}
    if(blendFactor(x, snowStart, snowEnd)>0.5){
      for(let y= Math.floor(WORLD_H/2)+1; y<Math.floor(WORLD_H/2)+8; y++){
        if(y<WORLD_H && world[y][x]===BLOCKS.AIR && Math.random()>0.78){
          world[y][x]=BLOCKS.ICE;
        }
      }
    }
  }

  genCaves();
  genMines();
  
  const cxp = Math.floor(WORLD_W/2);
  const cyp = findSurfaceY(cxp);
  spawn = {x: cxp*TILE, y:(cyp-1)*TILE - PLAYER_H};
}

function blendFactor(x, start, end){
  if(x>=start && x<=end) return 1;
  if(x>start-BLEND && x<start) return (x-(start-BLEND))/BLEND;
  if(x<end+BLEND && x>end) return ((end+BLEND)-x)/BLEND;
  return 0;
}
function findSurfaceY(x){
  for(let y=1;y<WORLD_H;y++){
    const b=world[y][x];
    if(b!==BLOCKS.AIR && b!==BLOCKS.CAVE_AIR && b!==BLOCKS.FLOWER && b!==BLOCKS.MOON_FLOWER && b!==BLOCKS.TALL_GRASS && b!==BLOCKS.SNOW_TALL_GRASS && b!==BLOCKS.SNOW) return y;
  }
  return Math.floor(WORLD_H/2);
}
function genCaves(){
  const surf = Math.floor(WORLD_H/2);
  const n = Math.floor(Math.random()*4)+3;
  for(let i=0;i<n;i++){
    const cx = Math.floor(Math.random()*(WORLD_W-20))+10;
    const cy = Math.floor(Math.random()*(WORLD_H-surf-10))+surf+10;
    const r = Math.floor(Math.random()*3)+4;
    for(let y=cy-r;y<=cy+r;y++){
      for(let x=cx-r;x<=cx+r;x++){
        if(x<0||x>=WORLD_W||y<0||y>=WORLD_H) continue;
        const d=Math.hypot(x-cx,y-cy);
        if(d<=r && Math.random()>0.3){
          world[y][x]=BLOCKS.CAVE_AIR;
          if(d>=r-1 && Math.random()>0.7) world[y][x]= (Math.random()>0.5?BLOCKS.COAL:BLOCKS.IRON);
        }
      }
    }
  }
}
function genMines(){
  const surf = Math.floor(WORLD_H/2);
  const n = Math.floor(Math.random()*2)+1;
  for(let i=0;i<n;i++){
    let mx = Math.floor(Math.random()*(WORLD_W-10))+5;
    const sy = findSurfaceY(mx);
    const depth = Math.floor(Math.random()*20)+30;
    const width = Math.floor(Math.random()*3)+3;
    let curX = mx, dir = Math.random()>0.5?1:-1;
    for(let y=sy;y<sy+depth;y++){
      if(Math.random()>0.9) dir = Math.random()>0.5?1:-1;
      curX += dir; curX = clamp(curX,0,WORLD_W-1);
      for(let w=-Math.floor(width/2); w<=Math.floor(width/2); w++){
        const x=curX+w;
        if(x<0||x>=WORLD_W||y<0||y>=WORLD_H) continue;
        world[y][x]=BLOCKS.CAVE_AIR;
        if((w===-Math.floor(width/2)||w===Math.floor(width/2)) && Math.random()>0.7){
          world[y][x]= (Math.random()>0.5?BLOCKS.COAL:BLOCKS.IRON);
        }
      }
      if(Math.random()>0.95){
        const len=Math.floor(Math.random()*5)+2, d = Math.random()>0.5?1:-1;
        for(let b=1;b<=len;b++){
          const bx = curX + b*d, by = y;
          if(bx<0||bx>=WORLD_W||by<0||by>=WORLD_H) continue;
          world[by][bx]=BLOCKS.CAVE_AIR;
          if(Math.random()>0.8) world[by][bx]=(Math.random()>0.5?BLOCKS.COAL:BLOCKS.IRON);
        }
      }
    }
  }
}

/* =================== –ó–ê–ì–†–£–ó–ö–ê –¢–ï–ö–°–¢–£–† =================== */
function loadTextures(cb){
  const list=[];
  list.push({k:'player_stand',url:TEX.player_stand});
  list.push({k:'player_right',url:TEX.player_right});
  list.push({k:'player_left',url:TEX.player_left});
  for(const [id,url] of Object.entries(TEX.blocks)) list.push({k:'b_'+id,url});
  for(const [id,url] of Object.entries(ITEMS)) list.push({k:'i_'+id,url});

  let done=0;
  if(list.length===0) return cb();

  for(const it of list){
    const img = new Image();
    img.onload=()=>{
      textures[it.k]=img; if(++done===list.length) cb();
    };
    img.onerror=()=>{
      const canvas = document.createElement('canvas'); canvas.width=32; canvas.height=32;
      const cc = canvas.getContext('2d'); cc.fillStyle = '#ff00ff'; cc.fillRect(0,0,32,32);
      textures[it.k]=canvas;
      console.warn('–ù–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å:', it.url);
      if(++done===list.length) cb();
    };
    img.src = it.url;
  }
}

/* =================== –í–•–û–î =================== */
const keys={};
window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  keys[k]=true;
  if(k===' ') e.preventDefault();
  if(k==='r') toggleCraftMenu();
});
window.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });

/* =================== –§–ò–ó–ò–ö–ê/–ò–ù–ü–£–¢ =================== */
function handleInput(){
  let targetVX=0;
  if(keys['a']||keys['arrowleft']||keys['—Ñ']) targetVX = -player.speed;
  if(keys['d']||keys['arrowright']||keys['–≤']) targetVX =  player.speed;
  inputTargetVX = targetVX;
  const accel = player.onIce? 0.05 : 0.34;
  player.vx += (targetVX - player.vx)*accel;
  if((keys['w']||keys['arrowup']||keys['—Ü']||keys[' ']) && player.onGround){
    player.vy = player.jump; player.onGround=false;
    if(audioEnabled) tryPlay(jumpS);
  }
}
function physics(dt){
  player.vy += 0.5 * (dt/16);
  player.vx = clamp(player.vx,-10,10);
  player.vy = clamp(player.vy,-40,40);
  player.x += player.vx*(dt/16);
  collideAxis('x');
  player.y += player.vy*(dt/16);
  collideAxis('y');

  const footY = player.y + player.h + 1;
  const lx = player.x + player.w*0.25;
  const rx = player.x + player.w*0.75;
  const lt = tileAt(lx,footY), rt = tileAt(rx,footY);
  player.onGround = isSolid(lt) || isSolid(rt);
  player.onIce = (lt===BLOCKS.ICE)||(rt===BLOCKS.ICE);

  if(player.onGround && !player.onIce){ player.vx *= 0.82; if(Math.abs(player.vx)<0.05) player.vx=0; }
  if(player.onIce){ player.vx *= 0.995; }

  player.x = clamp(player.x,0, WORLD_W*TILE - player.w);
  player.y = Math.min(player.y, WORLD_H*TILE - player.h);

  // –∫–∞–º–µ—Ä–∞ ‚Äî —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–æ—á–Ω–æ (CAMERA_SMOOTH=1 –¥–µ–ª–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ)
  const tx = player.x - cv.width/3;
  const ty = player.y - cv.height/2 + player.h*1.5;
  cam.x += (tx - cam.x)*CAMERA_SMOOTH;
  cam.y += (ty - cam.y)*CAMERA_SMOOTH;
  cam.x = clamp(cam.x,0, WORLD_W*TILE - cv.width);
  cam.y = clamp(cam.y,0, WORLD_H*TILE - cv.height);

  // –∞–Ω–∏–º–∞—Ü–∏—è —Ö–æ–¥—å–±—ã ‚Äî —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–æ –•, –¥–∞–∂–µ –≤ –≤–æ–∑–¥—É—Ö–µ
  player.walking = (Math.abs(inputTargetVX)>0.1);
  if(player.walking){
    player.frameT += dt;
    if(player.frameT > player.frameInterval){
      player.frameT=0; player.frame = (player.frame+1)%2;
      const now = performance.now();
      // —à–∞–≥ –∑–≤—É–∫–æ–≤–æ–π ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–∞ –∑–µ–º–ª–µ
      if(audioEnabled && player.onGround && now-lastWalkSound>WALK_SOUND_COOLDOWN){
        tryPlay(walkS); lastWalkSound = now;
      }
    }
  }else{
    player.frame=0; player.frameT=0;
  }
}
function collideAxis(axis){
  let l=player.x, r=player.x+player.w, t=player.y, b=player.y+player.h;
  const sx=Math.floor(l/TILE), ex=Math.floor((r-1)/TILE),
        sy=Math.floor(t/TILE), ey=Math.floor((b-1)/TILE);
  for(let ty=sy; ty<=ey; ty++){
    for(let tx=sx; tx<=ex; tx++){
      if(tx<0||tx>=WORLD_W||ty<0||ty>=WORLD_H) continue;
      const bl = world[ty][tx];
      if(!isSolid(bl)) continue;
      const bx=tx*TILE, by=ty*TILE;
      if(r>bx && l<bx+TILE && b>by && t<by+TILE){
        if(axis==='x'){
          if(player.vx>0){ player.x = bx - player.w - 0.01; player.vx=0; }
          else if(player.vx<0){ player.x = bx + TILE + 0.01; player.vx=0; }
          l=player.x; r=player.x+player.w;
        }else{
          if(player.vy>0){ player.y = by - player.h - 0.01; player.vy=0; player.onGround=true; }
          else if(player.vy<0){ player.y = by + TILE + 0.01; player.vy=0; }
          t=player.y; b=player.y+player.h;
        }
      }
    }
  }
}

/* =================== –î–ï–ù–¨/–ù–û–ß–¨ =================== */
function updateDay(dt){
  const ds = dt/1000;
  timeSec += ds;
  const len = isDay? DAY_LEN : NIGHT_LEN;
  if(timeSec >= len){
    timeSec = 0;
    isDay = !isDay;
    dayNightDiv.textContent = isDay?'–î–µ–Ω—å':'üåë–ù–æ—á—åüåë';
    trans = 0.0001;
  }
  if(trans>0 && trans<1){
    trans += ds/TRANSITION;
    if(trans>=1) trans=1;
  }else if(trans===0.0001){
    trans = ds/TRANSITION;
  }
}

/* =================== –°–ù–ï–ì =================== */
function updateSnow(dt){
  const px = Math.floor((player.x+player.w/2)/TILE);
  snowing = (px>=snowStart && px<=snowEnd) && !isDay;
  if(!snowing){ snowflakes=[]; return; }
  snowTimer += dt;
  if(snowTimer>100){
    snowTimer=0;
    const count = Math.floor(Math.random()*3)+1;
    for(let i=0;i<count;i++){
      snowflakes.push({x:Math.random()*cv.width, y:-10, s:Math.random()*3+2, v:Math.random()*2+1, d:Math.random()*2-1});
    }
  }
  for(let i=snowflakes.length-1;i>=0;i--){
    const f=snowflakes[i];
    f.y += f.v; f.x += f.d*0.2;
    if(f.y>cv.height+12) snowflakes.splice(i,1);
  }
}

/* =================== –†–ï–ù–î–ï–† =================== */
function drawSky(){
  const w=cv.width, h=cv.height;
  const dayTop = "#f6fbff", dayBot = "#87CEEB";
  const nightTop = "#0b1740", nightBot = "#0a1030";
  const g = cx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, dayTop);
  g.addColorStop(1, dayBot);
  cx.fillStyle = g;
  cx.fillRect(0,0,w,h);

  let nt = isDay? 0 : 1;
  if(trans>0 && trans<1){
    const k = clamp(trans,0,1);
    nt = isDay? (1-k)*1 : k*1;
  }
  if(nt>0){
    const ng = cx.createLinearGradient(0,0,0,h);
    ng.addColorStop(0, nightTop);
    ng.addColorStop(1, nightBot);
    cx.globalAlpha = clamp(nt,0,1)*0.92;
    cx.fillStyle = ng;
    cx.fillRect(0,0,w,h);
    cx.globalAlpha = 1;
  }
}
function drawSnow(){
  if(!snowing) return;
  cx.fillStyle='#fff';
  for(const f of snowflakes){ cx.beginPath(); cx.arc(f.x,f.y,f.s,0,Math.PI*2); cx.fill(); }
}

function render(){
  drawSky();

  const sx=Math.max(0, Math.floor(cam.x/TILE));
  const ex=Math.min(WORLD_W, sx + Math.ceil(cv.width/TILE)+1);
  const sy=Math.max(0, Math.floor(cam.y/TILE));
  const ey=Math.min(WORLD_H, sy + Math.ceil(cv.height/TILE)+1);

  for(let y=sy;y<ey;y++){
    for(let x=sx;x<ex;x++){
      const b=world[y][x];
      if(b===BLOCKS.AIR||b===BLOCKS.CAVE_AIR) continue;
      const dx=x*TILE-cam.x, dy=y*TILE-cam.y;
      const key='b_'+b;
      const img = textures[key];
      const semi = (b===BLOCKS.LEAVES||b===BLOCKS.FLOWER||b===BLOCKS.TALL_GRASS||b===BLOCKS.SNOW_TALL_GRASS||b===BLOCKS.MOON_FLOWER||b===BLOCKS.SNOW||b===BLOCKS.DEAD_BUSH||b===BLOCKS.WOOD_BG||b===BLOCKS.CACTUS);
      if(img){
        try {
          if(semi){ cx.globalAlpha=.78; cx.drawImage(img,dx,dy,TILE,TILE); cx.globalAlpha=1; }
          else cx.drawImage(img,dx,dy,TILE,TILE);
        } catch(e){
          cx.fillStyle='#ff00ff'; cx.fillRect(dx,dy,TILE,TILE);
        }
      }else{
        cx.fillStyle = '#ff00ff';
        cx.fillRect(dx,dy,TILE,TILE);
      }
    }
  }

  // furnace animation
  furnaceAnimTimer += 16;
  if(furnaceAnimTimer>300){ furnaceAnimTimer=0; furnaceAnimState ^= 1; }
  for(let y=sy;y<ey;y++){
    for(let x=sx;x<ex;x++){
      const b=world[y][x];
      if(b===BLOCKS.FURNACE_ON){
        const dx=x*TILE-cam.x, dy=y*TILE-cam.y;
        const texKey = Object.keys(textures).find(k=>k.includes('b_') && textures[k] && textures[k].src && textures[k].src.includes('furnace_on'));
        if(texKey) cx.drawImage(textures[texKey],dx,dy,TILE,TILE);
        else { cx.fillStyle='#b35400'; cx.fillRect(dx,dy,TILE,TILE); }
      }
    }
  }
  // –∏–≥—Ä–æ–∫ ‚Äî —Ç–µ–ø–µ—Ä—å –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ (–≤–∫–ª—é—á–∞—è –≤–æ–∑–¥—É—Ö) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —à–∞–≥–æ–≤
  let ptex = textures.player_stand;
  if(player.walking){
    ptex = (player.frame===0? textures.player_right : textures.player_left);
  } else ptex = textures.player_stand;
  const idle = (Math.abs(player.vx)<0.05 && player.onGround)? Math.sin(performance.now()/300)*2 : 0;
  cx.save();
  cx.translate(player.x - cam.x + player.w/2, player.y - cam.y + player.h/2 + idle);
  if(inputTargetVX < -0.1) player.facing=-1; else if(inputTargetVX>0.1) player.facing=1;
  if(player.facing===-1) cx.scale(-1,1);
  if(ptex) {
    try { cx.drawImage(ptex, -player.w/2, -player.h/2, player.w, player.h); }
    catch(e){ cx.fillStyle='#FF5722'; cx.fillRect(-player.w/2, -player.h/2, player.w, player.h); }
  } else { cx.fillStyle='#FF5722'; cx.fillRect(-player.w/2, -player.h/2, player.w, player.h); }
  cx.restore();

  // –Ω–æ—á–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ

  // –∑–≤—ë–∑–¥—ã –Ω–∞ –Ω–µ–±–µ

  

 

  // —Å–Ω–µ–≥
  drawSnow();

  // overlay darkness
  let alpha = 0;
  if(!isDay){
    alpha = trans<1 ? 0.55*trans : 0.55;
  } else {
    alpha = trans<1 ? 0.55*(1-trans) : 0;
  }
  if(alpha>0){
    cx.fillStyle = `rgba(0,0,0,${alpha})`;
    cx.fillRect(0,0,cv.width,cv.height);
  }
}

 if(!isDay){
    cx.save();
    cx.globalCompositeOperation = 'lighter';
    const lights = [];
    for(const key of torches){
      const [gx,gy] = key.split(',').map(Number);
      lights.push({x:gx*TILE+TILE/2, y:gy*TILE+TILE/2, r: TILE*3});
    }
    for(const key of burningFurnaces.keys()){
      const [gx,gy] = key.split(',').map(Number);
      lights.push({x:gx*TILE+TILE/2, y:gy*TILE+TILE/2, r: TILE*3.5});
    }
    for(const L of lights){
      const x=L.x - cam.x, y=L.y - cam.y;
      const g = cx.createRadialGradient(x,y,8, x,y,L.r);
      g.addColorStop(0,'rgba(255,220,150,.85)');
      g.addColorStop(1,'rgba(255,220,150,0)');
      cx.fillStyle=g;
      cx.beginPath(); cx.arc(x,y,L.r,0,Math.PI*2); cx.fill();
    }
    cx.restore();
  }

/* =================== –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø =================== */
cv.addEventListener('mousedown', onMouse);
cv.addEventListener('contextmenu', e=>e.preventDefault());
function onMouse(e){
  const mx = e.clientX + cam.x;
  const my = e.clientY + cam.y;
  const gx = Math.floor(mx/TILE);
  const gy = Math.floor(my/TILE);
  if(gx<0||gx>=WORLD_W||gy<0||gy>=WORLD_H) return;
  const bx = gx*TILE, by = gy*TILE;
  const px = player.x+player.w/2, py = player.y+player.h/2;
  const dist = Math.hypot((bx+TILE/2)-px,(by+TILE/2)-py);
  if(e.button===0){
    if(dist>PLACE_DIST) return;
    if(world[gy][gx]!==BLOCKS.AIR && world[gy][gx]!==BLOCKS.CAVE_AIR && !isPassable(world[gy][gx])) return;
    if(player.selectedBlock===BLOCKS.AIR) return;
    const check = canPlaceAt(gx,gy);
    if(!check.ok){
      if(check.reason==='self') showWarn('–ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫ –≤ —Å–µ–±–µ');
      else showWarn('–ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫ –≤ –≤–æ–∑–¥—É—Ö–µ');
      return;
    }

    if(useInv(player.selectedBlock,1)){
      world[gy][gx] = player.selectedBlock;
      if(player.selectedBlock===BLOCKS.TORCH) torches.add(gx+','+gy);
    }
  } else if(e.button===2){
    if(dist>BREAK_DIST) return;
    const t = world[gy][gx];
    if(t===BLOCKS.AIR || t===BLOCKS.CAVE_AIR) return;
    let need=null;
    //–õ–û–ú–ê–ù–ò–Ø –ë–õ–û–ö–û–í
    if((t===BLOCKS.STONE||t===BLOCKS.MOON_ROCK||t===BLOCKS.COAL||t===BLOCKS.IRON||t===BLOCKS.FURNACE_OFF||t===BLOCKS.FURNACE_ON ||t===BLOCKS.HARD_SAND ||t===BLOCKS.ICE) && !player.tools.pickaxe) need='–ö–∏—Ä–∫–∞';
    if((t===BLOCKS.DIRT||t===BLOCKS.GRASS||t===BLOCKS.SNOW_DIRT||t===BLOCKS.SNOW_GRASS||t===BLOCKS.SAND||t===BLOCKS.SNOW) && !player.tools.shovel) need='–õ–æ–ø–∞—Ç–∞';
    if((t===BLOCKS.WOOD||t===BLOCKS.WOOD_BG||t===BLOCKS.PLANKS||t===BLOCKS.WORKBENCH) && !player.tools.axe) need='–¢–æ–ø–æ—Ä';
    if(need){ showWarn('–ù—É–∂–Ω–∞: '+need); return; }
    if(t!==BLOCKS.BEDROCK){
      world[gy][gx] = (t===BLOCKS.FURNACE_ON ? BLOCKS.CAVE_AIR : BLOCKS.AIR);
      if(audioEnabled) tryPlay(breakS);
      if(t===BLOCKS.COAL) addInv(BLOCKS.COAL_ITEM,1);
      else if(t===BLOCKS.WOOD_BG) addInv(BLOCKS.WOOD,1);
      else if(t===BLOCKS.FURNACE_OFF || t===BLOCKS.FURNACE_ON){
        burningFurnaces.delete(gx+','+gy);
        addInv(BLOCKS.FURNACE_OFF,1);
      } else if(t===BLOCKS.TORCH){
        torches.delete(gx+','+gy);
        addInv(BLOCKS.TORCH,1);
      } else {
        addInv(t,1);
      }
    }
  }
}
/* =================== –ö–†–ê–§–¢ =================== */
function toggleCraftMenu(){
  craftMenu.style.display = (craftMenu.style.display==='flex'?'none':'flex'); }
craftBtn.addEventListener('click', toggleCraftMenu);
function clearCraftMenu(){ craftMenu.innerHTML=''; }
function addRecipeEl(imgs,text,onClick){
  const el = document.createElement('div');
  el.className='recipe';
  for(const im of imgs){
    const img = document.createElement('img');
    img.src = im;
    el.appendChild(img);
  }
  const span = document.createElement('span');
  span.textContent = text;
  el.appendChild(span);
  el.onclick = onClick;
  craftMenu.appendChild(el);
}
function nearBlock(targetId, radius=3){
  const gx = Math.floor((player.x+player.w/2)/TILE);
  const gy = Math.floor((player.y+player.h/2)/TILE);
  for(let y=gy-radius;y<=gy+radius;y++){
    for(let x=gx-radius;x<=gx+radius;x++){
      if(x<0||x>=WORLD_W||y<0||y>=WORLD_H) continue;
      if(world[y][x]===targetId) return true;
    }
  }
  return false;
}
function buildCraftMenu(){
  clearCraftMenu();
  // –î–æ—Å–∫–∏ 1 -> 5 (–∏–∫–æ–Ω–∫–∞ –±—Ä–µ–≤–Ω–æ -> —Å—Ç—Ä–µ–ª–∫–∞ -> –¥–æ—Å–∫–∞*5)
  addRecipeEl(["Texture/wood.png","Texture/arrow.png","Texture/planks.png"],"–î–æ—Å–∫–∏ x5", ()=>{
    if(useInv(BLOCKS.WOOD,1)){ addInv(BLOCKS.PLANKS,5); showTip('1 –±—Ä–µ–≤–Ω–æ ‚Üí 5 –¥–æ—Å–æ–∫'); }
    else showWarn('–ù—É–∂–Ω–æ: 1 –±—Ä–µ–≤–Ω–æ');
  });

  // –í–µ—Ä—Å—Ç–∞–∫ (15 –¥–æ—Å–æ–∫ -> 1 –≤–µ—Ä—Å—Ç–∞–∫) (–∏–∫–æ–Ω–∫–∞ –¥–æ—Å–∫–∏*15 -> —Å—Ç—Ä–µ–ª–∫–∞ -> –≤–µ—Ä—Å—Ç–∞–∫)
  addRecipeEl(["Texture/planks.png","Texture/arrow.png","Texture/workbench.png"],"–í–µ—Ä—Å—Ç–∞–∫ „Ö§„Ö§„Ö§15 ‚Üí x1", ()=>{
    if(useInv(BLOCKS.PLANKS,15)){ addInv(BLOCKS.WORKBENCH,1); showTip('–í–µ—Ä—Å—Ç–∞–∫ –≥–æ—Ç–æ–≤'); }
    else showWarn('–ù—É–∂–Ω–æ: 15 –¥–æ—Å–æ–∫');
  });

  // –§–∞–∫–µ–ª (2 –¥–æ—Å–∫–∏ + 1 —É–≥–æ–ª—å -> 3 —Ñ–∞–∫–µ–ª–∞) (–∏–∫–æ–Ω–∫–∏: —É–≥–æ–ª—å + –¥–æ—Å–∫–∞*2 -> —Å—Ç—Ä–µ–ª–∫–∞ -> —Ñ–∞–∫–µ–ª*3)
  addRecipeEl(["Texture/coal_item.png","Texture/planks.png","Texture/planks.png","Texture/arrow.png","Texture/torch.png"],"–§–∞–∫–µ–ª √ó3", ()=>{
    if((player.inv[BLOCKS.PLANKS]||0)>=2 && (player.inv[BLOCKS.COAL_ITEM]||0)>=1){
      useInv(BLOCKS.PLANKS,2); useInv(BLOCKS.COAL_ITEM,1);
      addInv(BLOCKS.TORCH,3); showTip('–°–∫—Ä–∞—Ñ—Ç–∏–ª 3 —Ñ–∞–∫–µ–ª–∞');
    } else showWarn('–ù—É–∂–Ω–æ: 2 –¥–æ—Å–∫–∏, 1 —É–≥–æ–ª—å');
  });

  // –ü–µ—á—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –º–µ–Ω—é –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ä—è–¥–æ–º –µ—Å—Ç—å –≤–µ—Ä—Å—Ç–∞–∫ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
  if(nearBlock(BLOCKS.WORKBENCH)){
    addRecipeEl(["Texture/planks.png","Texture/planks.png","Texture/planks.png","Texture/planks.png","Texture/planks.png","Texture/planks.png","Texture/stone.png","Texture/stone.png","Texture/stone.png","Texture/stone.png","Texture/stone.png","Texture/stone.png","Texture/stone.png","Texture/stone.png","Texture/stone.png","Texture/arrow.png","Texture/furnace_off.png"],
    "–ü–µ—á—å (6 –¥–æ—Å–æ–∫ + 9 –∫–∞–º–Ω—è)", ()=>{
      if((player.inv[BLOCKS.PLANKS]||0)>=6 && (player.inv[BLOCKS.STONE]||0)>=9){
        useInv(BLOCKS.PLANKS,6); useInv(BLOCKS.STONE,9);
        addInv(BLOCKS.FURNACE_OFF,1); showTip('–ü–µ—á—å –≥–æ—Ç–æ–≤–∞');
      } else showWarn('–ù—É–∂–Ω–æ: 6 –¥–æ—Å–æ–∫, 9 –∫–∞–º–Ω—è');
    });
  }

  // –ü–µ—Ä–µ–ø–ª–∞–≤–∫–∞ ‚Äî –µ—Å–ª–∏ —Ä—è–¥–æ–º –ø–µ—á—å
  if(nearBlock(BLOCKS.FURNACE_OFF) || nearBlock(BLOCKS.FURNACE_ON)){
    addRecipeEl(["Texture/iron.png","Texture/coal_item.png","Texture/arrow.png","Texture/iron_ingot.png"],"–ü–ª–∞–≤–∏—Ç—å –∂–µ–ª–µ–∑–æ (15 —Å–µ–∫)", ()=>{
      if((player.inv[BLOCKS.IRON]||0)>=1 && (player.inv[BLOCKS.COAL_ITEM]||0)>=1){
        const gx = Math.floor((player.x+player.w/2)/TILE);
        const gy = Math.floor((player.y+player.h/2)/TILE);
        let fx=-1,fy=-1;
        outer: for(let y=gy-3;y<=gy+3;y++){
          for(let x=gx-3;x<=gx+3;x++){
            if(x<0||x>=WORLD_W||y<0||y>=WORLD_H) continue;
            if(world[y][x]===BLOCKS.FURNACE_OFF || world[y][x]===BLOCKS.FURNACE_ON){ fx=x; fy=y; break outer; }
          }
        }
        if(fx>=0){
          useInv(BLOCKS.IRON,1); useInv(BLOCKS.COAL_ITEM,1);
          world[fy][fx]=BLOCKS.FURNACE_ON;
          const key=fx+','+fy;
          burningFurnaces.set(key,{t:15,active:true});
          showTip('–ü–ª–∞–≤–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å (15 —Å–µ–∫)');
        } else showWarn('–ù—É–∂–Ω–∞ –ø–µ—á—å —Ä—è–¥–æ–º');
      } else showWarn('–ù—É–∂–Ω–æ: 1 –∂–µ–ª–µ–∑–Ω–∞—è —Ä—É–¥–∞ –∏ 1 —É–≥–æ–ª—å');
    });
  }
}
/* =================== –ê–£–î–ò–û =================== */
function tryPlay(el){
  try{ if(el) el.currentTime = 0, el.play(); } catch(e){ /* –∏–≥–Ω–æ—Ä */ }
}
audioBtn.addEventListener('click', ()=>{
  audioEnabled = !audioEnabled;
  audioBtn.textContent = audioEnabled? 'üîä –ó–≤—É–∫' : 'üîá –ó–≤—É–∫';
  if(audioEnabled) try { bgm.play().catch(()=>{}); } catch(e){}
  else try{ bgm.pause(); } catch(e){}
});
helpBtn.addEventListener('click', ()=>{ showHelp = !showHelp; help.style.display = showHelp? 'block' : 'none'; });
/* =================== –õ–æ–≥–∏–∫–∞ –ø–µ—á–µ–π –∏ —Ç–∞–π–º–µ—Ä–æ–≤ =================== */
function tickFurnaces(dt){
  for(const [key, val] of burningFurnaces.entries()){
    val.t -= dt/1000;
    if(val.t<=0){
      addInv(BLOCKS.IRON_INGOT,1);
      burningFurnaces.delete(key);
      const [gx,gy] = key.split(',').map(Number);
      if(world[gy] && world[gy][gx]===BLOCKS.FURNACE_ON) world[gy][gx]=BLOCKS.FURNACE_OFF;
    }
  }
}
/* =================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø/–û–ë–†–ê–ë–û–¢–ö–ê –†–ê–ó–ú–ï–†–ê =================== */
function resize(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const w = Math.max(320, Math.floor(window.innerWidth));
  const h = Math.max(240, Math.floor(window.innerHeight));
  cv.style.width = w + 'px';
  cv.style.height = h + 'px';
  cv.width = Math.floor(w * dpr);
  cv.height = Math.floor(h * dpr);
  cx.setTransform(dpr,0,0,dpr,0,0); }
window.addEventListener('resize', resize);

/* =================== –¶–ò–ö–õ –ò –ò–ù–ò–¢ =================== */
function init(){
  resize();
  genWorld();
  player.x = spawn.x; player.y = spawn.y;
  cam.x = player.x - cv.width/2 + player.w/2;
  cam.y = player.y - cv.height/2 + player.h/2;

  // –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
  resetInventory();
  initTools();
  buildCraftMenu();
  refreshInventory();
  lastTime = performance.now();
  loop();
}
function loop(){
  const now = performance.now();
  let dt = now - lastTime;
  if(dt>60) dt=60;
  lastTime = now;
  handleInput();
  physics(dt);
  updateDay(dt);
  updateSnow(dt);
  tickFurnaces(dt);
  render();
  const px = Math.floor((player.x+player.w/2)/TILE), py = Math.floor((player.y+player.h/2)/TILE);
  document.getElementById('hud').textContent = `x:${px} y:${py} vx:${player.vx.toFixed(1)} vy:${player.vy.toFixed(1)}`;
  requestAnimationFrame(loop);
}

/* =================== –ó–ê–ì–†–£–ó–ö–ê + –°–¢–ê–†–¢ =================== */
loadTextures(()=>{
  window.addEventListener('keydown', (e)=>{
    if(e.key>='1' && e.key<='9'){
      const idx = Number(e.key)-1;
      const slots = Array.from(inventoryDiv.querySelectorAll('.slot'));
      if(slots[idx]) slots[idx].click();
    }
  });

  init();
});
cv.addEventListener('pointerdown', ()=>{ if(audioEnabled) try{ bgm.play().catch(()=>{}); }catch(e){} }, {once:true});
/* =================== –ó–ê–©–ò–¢–´: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä =================== */
setTimeout(()=>{
  const anyTexture = Object.keys(textures).length>0;
  if(!anyTexture){
    console.warn('–í–Ω–∏–º–∞–Ω–∏–µ: —Ç–µ–∫—Å—Ç—É—Ä—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–∞–ø–∫—É Texture/ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤.');
    cx.fillStyle='#333'; cx.fillRect(0,0,cv.width,cv.height);
    cx.fillStyle='#fff'; cx.font='16px monospace'; cx.fillText('Textures missing ‚Äî check Texture/ folder',20,40);
  }
}, 2500);
</script>
<script src="Game.js"></script>
</body>
</html>