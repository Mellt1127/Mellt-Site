<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Adventure of Spark</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{--ui-bg:rgba(0,0,0,.65);--ui-fg:#fff}
  *{box-sizing:border-box}
  body{margin:0;overflow:hidden;background:#9fd3ff;font-family:'Press Start 2P',cursive;image-rendering:pixelated}
  canvas{display:block;width:100vw;height:100vh}
  #hud{position:fixed;top:8px;left:8px;color:var(--ui-fg);font-size:1rem;z-index:10;text-shadow:1px 1px 0 #000}
  #dayNight{position:fixed;top:8px;left:50%;transform:translateX(-50%);background:var(--ui-bg);color:var(--ui-fg);padding:6px 10px;border-radius:6px;font-size:1rem;z-index:10}
  #buttons{position:fixed;top:8px;right:8px;display:flex;gap:8px;z-index:12}
  .btn{background:var(--ui-bg);color:var(--ui-fg);border:none;border-radius:6px;padding:6px 10px;font-size:.9rem;cursor:pointer}
  #tooltip{position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:var(--ui-bg);color:#ffef8a;padding:8px 12px;border-radius:6px;font-size:.9rem;opacity:0;pointer-events:none;transition:opacity .2s, transform .2s;z-index:20}
  #help{position:fixed;top:48px;right:8px;background:var(--ui-bg);color:var(--ui-fg);padding:10px;border-radius:10px;font-size:.85rem;display:none;z-index:15;max-width:min(380px,90vw);line-height:1.6}
  #inventory,#tools{position:fixed;bottom:18px;display:flex;gap:8px;background:var(--ui-bg);padding:8px;border-radius:10px;z-index:12}
  #inventory{left:50%;transform:translateX(-50%)}
  #tools{right:10px;bottom:80px}
  .slot{width:42px;height:42px;border:2px solid #555;background:#222 center/cover no-repeat;position:relative;cursor:pointer}
  .slot.active{border-color:gold;box-shadow:0 0 8px gold}
  .count{position:absolute;bottom:1px;right:2px;font-size:.75rem;color:#fff;text-shadow:1px 1px 0 #000}
  #craftMenu{position:fixed;right:10px;bottom:230px;display:none;flex-direction:column;gap:8px;background:var(--ui-bg);padding:12px;border-radius:10px;z-index:15;width:300px}
  .recipe{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.05);padding:8px;border-radius:8px;font-size:.85rem;color:#fff;cursor:pointer}
  .recipe img{width:26px;height:26px;image-rendering:pixelated}
  canvas{background:#46daff}
</style>
</head>
<body>
  <div id="hud"></div>
  <div id="dayNight">–î–µ–Ω—å</div>
  <div id="buttons">
    <button id="helpBtn" class="btn">–ü–æ–¥—Å–∫–∞–∑–∫–∏‚ùì</button>
    <button id="audioBtn" class="btn">–ó–≤—É–∫üîà</button>
    <button id="craftBtn" class="btn">–ö—Ä–∞—Ñ—Çüß∞</button>
  </div>

  <div id="help">
    ‚Ä¢WASD/–°—Ç—Ä–µ–ª–∫–∏ ‚Äî –ü–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–µ<br>
    ‚Ä¢–ü—Ä–æ–±–µ–ª ‚Äî –ü—Ä—ã–∂–æ–∫<br>
    ‚Ä¢–õ–ö–ú ‚Äî –°—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫ (–ú–∞–∫—Å. –¥–∏—Å—Ç–∞–Ω—Ü–∏—è 5 –±–ª–æ–∫–æ–≤)<br> 
    ‚Ä¢–ü–ö–ú ‚Äî –õ–æ–º–∞—Ç—å –±–ª–æ–∫ (–ú–∞–∫—Å. –¥–∏—Å—Ç–∞–Ω—Ü–∏—è 5 –±–ª–æ–∫–æ–≤)<br>
    ‚Ä¢1‚Äì9 ‚Äî –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä —Å–ª–æ—Ç–∞<br>
    ‚Ä¢R ‚Äî –û—Ç–∫—Ä—ã—Ç—å/–ó–∞–∫—Ä—ã—Ç—å –∫—Ä–∞—Ñ—Ç
  </div>

  <div id="tooltip"></div>
  <canvas id="cv"></canvas>
  <div id="inventory"></div>
  <div id="tools"></div>
  <div id="craftMenu"></div>

  <!-- –∞—É–¥–∏–æ (–±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –µ—Å–ª–∏ –µ—Å—Ç—å) -->
  <audio id="jumpS"><source src="sound/jump.wav" type="audio/wav"></audio>
  <audio id="breakS"><source src="sound/break.wav" type="audio/wav"></audio>
  <audio id="walkS"><source src="sound/walk.wav" type="audio/wav"></audio>
  <audio id="bgm" loop><source src="sound/background.mp3" type="audio/mp3"></audio>

<script>
/* ======= –ö–û–ù–°–¢–ê–ù–¢–´ ======= */
const TILE = 42;
const WORLD_W = 1000;      // —à–∏—Ä–∏–Ω–∞ –º–∏—Ä–∞ –≤ –±–ª–æ–∫–∞—Ö
const WORLD_H = 100;       // –≤—ã—Å–æ—Ç–∞ –≤ –±–ª–æ–∫–∞—Ö
const VIEW_W =  Math.max(12, Math.floor(window.innerWidth / TILE));
const VIEW_H =  Math.max(8, Math.floor(window.innerHeight / TILE));
const PLAYER_W = TILE * 1;             // –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 1 –±–ª–æ–∫ –≤ —à–∏—Ä–∏–Ω—É
const PLAYER_H = TILE * 1.95;         // –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: 2 –±–ª–æ–∫–∞ –≤ –≤—ã—Å–æ—Ç—É
const PLACE_DIST = TILE*5;
const BREAK_DIST = TILE*5;
const DAY_LEN = 180; // 3 minutes = 180s
const NIGHT_LEN = 60; // 1 minute = 60s

/* ======= –ó–ê–ì–†–£–ó–ö–ê –ê–°–ï–¢–û–í ======= */
const ASSETS = {
  images: {
    player_stand:'texture/player_stand.png',
    player_left:'texture/player_left.png',
    player_right:'texture/player_right.png', 
    
    axe: 'texture/axe',
    pickaxe: 'texture/pickaxe',
    shovel: 'texture/shovel',

    bedrock: 'texture/bedrock',
    cactus:'texture/cactus.png',
    coal_item:'texture/coal_item.png',
    coal_ore: 'texture/coal_ore',
    dead_bush: 'texture/dead_bush',
    dirt:'texture/dirt.png',
    flower:'texture/flower.png',
    furnace:'texture/furnace.png',
    furnace_on1:'texture/furnace_on1.png',
    furnace_on2:'texture/furnace_on2.png',
    grass:'texture/grass.png',
    ice: 'texture/ice',
    iron_ingot:'texture/iron_ingot.png',
    iron_ore:'texture/iron_ore.png',
    leaves:'texture/leaves.png',
    moon_flower:'texture/moon_flower.png',
    moon_rock: 'texture/moon_rock',
    planks:'texture/planks.png',
    sand:'texture/sand.png',
    snow:'texture/snow.png',
    snow_dirt:'texture/snow_dirt.png',
    snow_grass:'texture/snow_grass.png',
    snow_tall_grass:'texture/snow_tall_grass.png',
    stone:'texture/stone.png',
    tall_grass:'texture/tall_grass.png',
    torch:'texture/torch.png',
    wood:'texture/wood.png',
    workbench:'texture/workbench.png'
  },
  audio: {
    jump:'sound/jump.wav',
    walk:'sound/walk.wav',
    break:'sound/break.wav',
    bgm:'sound/background.mp3'
  }
};

let images = {};
let audios = {};
let audioEnabled = true;

/* –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
function loadAssets(callback){
  const keys = Object.keys(ASSETS.images);
  let loaded = 0;
  if(keys.length===0){callback(); return;}
  keys.forEach(k=>{
    const img = new Image();
    img.src = ASSETS.images[k];
    img.onload = ()=>{ loaded++; if(loaded===keys.length) callback(); };
    img.onerror = ()=>{ console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å', ASSETS.images[k]); loaded++; if(loaded===keys.length) callback(); };
    images[k] = img;
  });
  // audio
  Object.keys(ASSETS.audio).forEach(k=>{
    const a = document.getElementById(k==='bgm'?'bgm':k+'S') || new Audio(ASSETS.audio[k]);
    audios[k]=a;
    a.volume = 0.6;
  });
}

/* ======= HTML –≠–õ–ï–ú–ï–ù–¢–´ ======= */
const canvas = document.getElementById('cv');
const ctx = canvas.getContext('2d');
const hud = document.getElementById('hud');
const dayNight = document.getElementById('dayNight');
const inventoryDiv = document.getElementById('inventory');
const toolsDiv = document.getElementById('tools');
const craftMenu = document.getElementById('craftMenu');
const helpDiv = document.getElementById('help');
const audioBtn = document.getElementById('audioBtn');
const helpBtn = document.getElementById('helpBtn');
const craftBtn = document.getElementById('craftBtn');

/* ======= –ú–ò–† / –¢–ê–ô–õ–´ ======= */
const TILE_AIR=0, TILE_DIRT=1, TILE_GRASS=2, TILE_STONE=3, TILE_SAND=4, TILE_SNOW=5, TILE_WOOD=6, TILE_LEAVES=7, TILE_CACTUS=8, TILE_PLANKS=9, TILE_TORCH=10, TILE_FURNACE=11, TILE_WORKBENCH=12, TILE_FLOWER=13;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
let world = new Array(WORLD_W);
for(let x=0;x<WORLD_W;x++){ world[x] = new Array(WORLD_H).fill(TILE_AIR); }

/* –ø—Ä–æ—Å—Ç–∞—è –ø—Å–µ–≤–¥–æ-—à—É–º–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è (smoothed random) */
function pseudoNoise(x, seed=12345){
  const n = Math.sin((x+seed)*12.9898)*43758.5453;
  return n - Math.floor(n);
}

/* –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏—Ä–∞ —Å –±–∏–æ–º–∞–º–∏: plains, desert, snow */
function generateWorld(){
  // –¥–µ–ª–∏–º –º–∏—Ä –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã –±–∏–æ–º–æ–≤ –ø–æ —à—É–º—É
  for(let x=0;x<WORLD_W;x++){
    const n = pseudoNoise(x*0.01, 42);
    // –±–∏–æ–º –≤—ã–±–æ—Ä
    let biome = 'plains';
    if(n < 0.25) biome='desert';
    else if(n > 0.75) biome='snow';
    // –≤—ã—Å–æ—Ç–∞ –∑–µ–º–ª–∏
    const heightBase = Math.floor(WORLD_H*0.45);
    const variation = Math.floor((pseudoNoise(x*0.3, 999)-0.5)*8); // -4..+4
    let groundY = heightBase + variation;
    // make hills
    groundY += Math.floor(8 * pseudoNoise(x*0.07, 2023) * (biome==='plains'?1:0.6));
    if(biome==='desert') groundY += 1;
    if(biome==='snow') groundY -= 1;
    if(groundY<10) groundY=10;
    if(groundY>WORLD_H-6) groundY=WORLD_H-6;

    // fill blocks below
    for(let y = groundY; y < WORLD_H; y++){
      if(y > groundY+6) world[x][y] = TILE_STONE;
      else {
        if(biome==='desert') world[x][y] = TILE_SAND;
        else if(biome==='snow') world[x][y] = TILE_DIRT;
        else world[x][y] = TILE_DIRT;
      }
    }
    // top block - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
    if(groundY-1 >= 0 && groundY-1 < WORLD_H){
      if(biome==='desert') world[x][groundY-1] = TILE_SAND;
      else if(biome==='snow') world[x][groundY-1] = TILE_SNOW;
      else world[x][groundY-1] = TILE_GRASS;
    }

    // decorations: trees, cactus, flowers
    const decor = pseudoNoise(x*0.5, 55);
    if(biome==='plains' && decor>0.85){
      // simple tree ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä–∞–Ω–∏—Ü –ø–æ X –∏ Y
      if(groundY-2 > 0 && groundY-3 >= 0 && x > 0 && x < WORLD_W-1){
        world[x][groundY-2] = TILE_WOOD;
        world[x+1][groundY-2] = TILE_LEAVES;
        world[x-1][groundY-2] = TILE_LEAVES;
        world[x][groundY-3] = TILE_LEAVES;
      }
    } else if(biome==='desert' && decor>0.9){
      // cactus
      if(groundY-2 > 0 && groundY-3 >= 0){
        world[x][groundY-2] = TILE_CACTUS;
        world[x][groundY-3] = TILE_CACTUS;
      }
    } else if(biome==='plains' && decor>0.8){
      // flower
      if(groundY-2 > 0){
        world[x][groundY-2] = 1000 + 1; // special marker for flower (we'll draw from texture flower)
      }
    }
    // occasional furnace/workbench on surface
    if(pseudoNoise(x*0.2,777)>0.995){
      if(groundY-2 > 0) world[x][groundY-2] = TILE_WORKBENCH;
    } else if(pseudoNoise(x*0.2,888)>0.995){
      if(groundY-2 > 0) world[x][groundY-2] = TILE_FURNACE;
    }
  }
}

/* ======= –†–ò–°–û–í–ê–ù–ò–ï –¢–ê–ô–õ–û–í ======= */
function drawTile(xPixel, yPixel, tile){
  // tile drawing by mapping tile id to image
  switch(tile){
    case TILE_DIRT: drawImageIfExists('dirt', xPixel, yPixel); break;
    case TILE_GRASS: drawImageIfExists('grass', xPixel, yPixel); break;
    case TILE_STONE: drawImageIfExists('stone', xPixel, yPixel); break;
    case TILE_SAND: drawImageIfExists('sand', xPixel, yPixel); break;
    case TILE_SNOW: drawImageIfExists('snow', xPixel, yPixel); break;
    case TILE_WOOD: drawImageIfExists('wood', xPixel, yPixel); break;
    case TILE_PLANKS: drawImageIfExists('planks', xPixel, yPixel); break;
    case TILE_LEAVES: drawImageIfExists('leaves', xPixel, yPixel); break;
    case TILE_CACTUS: drawImageIfExists('cactus', xPixel, yPixel); break;
    case TILE_TORCH: drawImageIfExists('torch', xPixel, yPixel); break;
    case TILE_FURNACE: drawImageIfExists('furnace', xPixel, yPixel); break;
    case TILE_WORKBENCH: drawImageIfExists('workbench', xPixel, yPixel); break;
    default:
      // special flowers (1001 etc) -> draw flower
      if(tile >= 1000){
        drawImageIfExists('flower', xPixel, yPixel);
      }
  }
}
function drawImageIfExists(key, x, y){
  const img = images[key];
  if(img && img.complete){
    ctx.drawImage(img, x, y, TILE, TILE);
  } else {
    // placeholder rect
    ctx.fillStyle = '#777';
    ctx.fillRect(x,y,TILE,TILE);
  }
}

/* ======= –ò–ì–†–û–ö ======= */
let player = {
  x: Math.floor(WORLD_W/2) * TILE,
  y: 0,
  vx:0, vy:0,
  w:PLAYER_W, h:PLAYER_H,
  onGround:false,
  dir:0, // -1 left, 0 stand, 1 right
  frameTime:0
};

/* —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: –Ω–∞–π—Ç–∏ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å —Ä—è–¥–æ–º —Å center */
function placePlayerOnSurface(){
  const cx = Math.floor(WORLD_W/2);
  for(let y=0;y<WORLD_H;y++){
    if(world[cx][y] !== TILE_AIR){
      player.x = cx*TILE + TILE/2 - player.w/2;
      player.y = (y-1)*TILE - player.h;
      return;
    }
  }
}

/* ======= –§–ò–ó–ò–ö–ê –∏ –£–ü–†–ê–í–õ–ï–ù–ò–ï ======= */
const keys = {};
window.addEventListener('keydown', e=>{
  keys[e.key.toLowerCase()] = true;
  if(e.key==='r' || e.key==='R'){ toggleCraft(); }
  if(e.key>='1' && e.key<='9'){ selectSlot(Number(e.key)-1); }
});
window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });

let mouse = {x:0,y:0,down:false,rightDown:false};
canvas.addEventListener('mousemove', e=>{
  const rect = canvas.getBoundingClientRect();
  mouse.x = (e.clientX - rect.left);
  mouse.y = (e.clientY - rect.top);
});
canvas.addEventListener('mousedown', e=>{
  if(e.button===0) mouse.down = true;
  if(e.button===2) mouse.rightDown = true;
});
canvas.addEventListener('mouseup', e=>{
  if(e.button===0) mouse.down = false;
  if(e.button===2) mouse.rightDown = false;
});
canvas.addEventListener('contextmenu', e=>{ e.preventDefault(); });

/* –∫–æ–ª–ª–∏–∑–∏–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –±–ª–æ–∫–∞) */
function isSolidTile(tx, ty){
  if(tx<0 || tx>=WORLD_W || ty<0 || ty>=WORLD_H) return true;
  const t = world[tx] && world[tx][ty];
  return t !== TILE_AIR && typeof t !== 'undefined';
}

/* –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ø–∏–∫—Å–µ–ª–µ–π –≤ —Ç–∞–π–ª—ã */
function pixelToTile(px, py){
  return {tx: Math.floor(px / TILE), ty: Math.floor(py / TILE)};
}

/* ======= –ò–ù–í–ï–ù–¢–ê–†–¨ –∏ –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ ======= */
let hotbar = new Array(9).fill(null); // {id:tile,count}
let tools = { pickaxe:{dur:999}, axe:{dur:999}, shovel:{dur:999} };
let selectedSlot = 0;

/* –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
function renderInventory(){
  inventoryDiv.innerHTML = '';
  for(let i=0;i<9;i++){
    const s = document.createElement('div'); s.className='slot' + (i===selectedSlot?' active':'');
    s.style.backgroundImage = hotbar[i] ? `url(${tileToTexture(hotbar[i].id)})` : '';
    s.addEventListener('click', ()=>{ selectSlot(i); });
    const c = document.createElement('div'); c.className='count'; c.textContent = hotbar[i] ? hotbar[i].count : '';
    s.appendChild(c);
    inventoryDiv.appendChild(s);
  }
}
function tileToTexture(id){
  switch(id){
    case TILE_DIRT: return ASSETS.images.dirt;
    case TILE_GRASS: return ASSETS.images.grass;
    case TILE_STONE: return ASSETS.images.stone;
    case TILE_SAND: return ASSETS.images.sand;
    case TILE_SNOW: return ASSETS.images.snow;
    case TILE_PLANKS: return ASSETS.images.planks;
    case TILE_WOOD: return ASSETS.images.wood;
    case TILE_TORCH: return ASSETS.images.torch;
    case TILE_FURNACE: return ASSETS.images.furnace;
    case TILE_WORKBENCH: return ASSETS.images.workbench;
    default: return '';
  }
}
function selectSlot(i){ selectedSlot = i; renderInventory(); }

/* –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (—Å—Ç–µ–∫—É–µ—Ç—Å—è –ø–æ id) */
function addToInventory(id, qty=1){
  for(let i=0;i<9;i++){
    if(hotbar[i] && hotbar[i].id===id){ hotbar[i].count += qty; renderInventory(); return true; }
  }
  // –ø—É—Å—Ç–æ–π —Å–ª–æ—Ç
  for(let i=0;i<9;i++){
    if(!hotbar[i]){ hotbar[i] = {id:id,count:qty}; renderInventory(); return true; }
  }
  return false; // full
}

/* —É–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–ª–æ—Ç–∞ –ø—Ä–∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ */
function useFromSelected(){
  const slot = hotbar[selectedSlot];
  if(!slot) return false;
  slot.count--;
  if(slot.count<=0) hotbar[selectedSlot] = null;
  renderInventory();
  return true;
}

/* ======= –ö–†–ê–§–¢ ======= */
const RECIPES = [
  {name:'1 –ë—Ä–µ–≤–Ω–æ -> 3 –î–æ—Å–∫–∏', inputs:[{id:TILE_WOOD,qty:1}], outputs:[{id:TILE_PLANKS,qty:3}]},
  {name:'15 –î–æ—Å–æ–∫ -> –í–µ—Ä—Å—Ç–∞–∫', inputs:[{id:TILE_PLANKS,qty:15}], outputs:[{id:TILE_WORKBENCH,qty:1}]},
  {name:'9 –ö–∞–º–Ω—è + 6 –î–æ—Å–æ–∫ -> –ü–µ—á—å', inputs:[{id:TILE_STONE,qty:9},{id:TILE_PLANKS,qty:6}], outputs:[{id:TILE_FURNACE,qty:1}]},
  {name:'1 –£–≥–æ–ª—å + 2 –î–µ—Ä–µ–≤–æ -> –§–∞–∫–µ–ª', inputs:[{id:1001/*coal placeholder*/,qty:1},{id:TILE_WOOD,qty:2}], outputs:[{id:TILE_TORCH,qty:3}]}
];

function toggleCraft(){ craftMenu.style.display = craftMenu.style.display==='none'?'flex':'none'; updateCraftMenu(); }
craftBtn.addEventListener('click', ()=>{ toggleCraft(); });
function updateCraftMenu(){
  craftMenu.innerHTML = '';
  RECIPES.forEach((r, idx)=>{
    const el = document.createElement('div'); el.className='recipe';
    el.textContent = r.name;
    el.addEventListener('click', ()=>{ tryCraft(r); });
    craftMenu.appendChild(el);
  });
}
function tryCraft(recipe){
  // simple inventory check on hotbar only for demo (could expand to full inventory)
  const needed = {};
  recipe.inputs.forEach(i=>{ needed[i.id] = (needed[i.id]||0) + i.qty; });
  const have = {};
  for(let s of hotbar){ if(s){ have[s.id] = (have[s.id]||0) + s.count; } }
  for(let id in needed){ if((have[id]||0) < needed[id]){ alert('–ù–µ—Ö–≤–∞—Ç–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤'); return; } }
  // remove materials from hotbar
  for(let id in needed){
    let need = needed[id];
    for(let i=0;i<9 && need>0;i++){
      if(hotbar[i] && hotbar[i].id==id){
        const take = Math.min(need, hotbar[i].count);
        hotbar[i].count -= take; need -= take;
        if(hotbar[i].count<=0) hotbar[i]=null;
      }
    }
  }
  // give outputs
  recipe.outputs.forEach(o=>{ addToInventory(o.id, o.qty); });
  renderInventory();
}

/* ======= –û–¢–†–ò–°–û–í–ö–ê / –ö–ê–ú–ï–†–ê ======= */
let cameraX = 0, cameraY = 0;
function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);

/* —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã –Ω–∞ –∏–≥—Ä–æ–∫–µ */
function updateCamera(){
  const targetX = player.x + player.w/2 - canvas.width/2;
  const targetY = player.y + player.h/2 - canvas.height/2;
  // –ø–ª–∞–≤–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
  cameraX += (targetX - cameraX) * 0.15;
  cameraY += (targetY - cameraY) * 0.15;
  // clamp
  cameraX = Math.max(0, Math.min(cameraX, WORLD_W*TILE - canvas.width));
  cameraY = Math.max(0, Math.min(cameraY, WORLD_H*TILE - canvas.height));
}

/* –¥–µ–Ω—å/–Ω–æ—á—å */
let timeOfDaySec = 0;
let isDay = true;
function updateDayNight(dt){
  timeOfDaySec += dt;
  const cycle = (isDay?DAY_LEN:NIGHT_LEN);
  if(timeOfDaySec >= cycle){ timeOfDaySec = 0; isDay = !isDay; }
  dayNight.textContent = isDay ? '–î–µ–Ω—å‚òÄÔ∏è' : '–ù–æ—á—åüåë';
}

/* —Ä–∏—Å–æ–≤–∞—Ç—å —Å—Ü–µ–Ω—É */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // world tiles visible region
  const startTx = Math.floor(cameraX / TILE);
  const startTy = Math.floor(cameraY / TILE);
  const cols = Math.ceil(canvas.width / TILE) + 2;
  const rows = Math.ceil(canvas.height / TILE) + 2;

  for(let tx = startTx; tx < startTx + cols; tx++){
    for(let ty = startTy; ty < startTy + rows; ty++){
      if(tx<0 || tx>=WORLD_W || ty<0 || ty>=WORLD_H) continue;
      const tile = world[tx][ty];
      const xPixel = Math.round(tx*TILE - cameraX);
      const yPixel = Math.round(ty*TILE - cameraY);
      if(tile !== TILE_AIR){
        drawTile(xPixel, yPixel, tile);
      }
    }
  }

  // draw player
  const px = Math.round(player.x - cameraX);
  const py = Math.round(player.y - cameraY);
  let imgKey = 'player_stand';
  if(player.dir < 0) imgKey = 'player_left';
  else if(player.dir > 0) imgKey = 'player_right';
  const img = images[imgKey];
  if(img && img.complete) ctx.drawImage(img, px, py, player.w, player.h);
  else {
    ctx.fillStyle='magenta'; ctx.fillRect(px,py,player.w,player.h);
  }

  // overlay for night
  if(!isDay){
    ctx.fillStyle = 'rgba(0,0,40,0.45)'; // dark bluish
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }

  // HUD
  hud.innerHTML = `x:${Math.floor((player.x+player.w/2)/TILE)} y:${Math.floor((player.y+player.h)/TILE)}`;
}

/* ======= –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ======= */
let lastTime = performance.now();
function loop(now){
  const dt = (now - lastTime)/1000; lastTime = now;
  update(dt);
  render();
  requestAnimationFrame(loop);
}

function update(dt){
  // controls
  let ax = 0;
  if(keys['a'] || keys['arrowleft'] || keys['—Ñ']){ ax = -600; player.dir = -1; }
  else if(keys['d'] || keys['arrowright'] || keys['–≤']){ ax = 600; player.dir = 1; }
  else { ax = 0; player.dir = 0; }

  // horizontal
  const friction = 8;
  player.vx += ax * dt;
  player.vx *= Math.pow(0.8, dt*friction);
  if(Math.abs(player.vx) < 5) player.vx = 0;

  // gravity
  const GRAV = 1500;
  player.vy += GRAV * dt;
  // jump
  if((keys['w'] || keys[' '] || keys['arrowup']) && player.onGround){ player.vy = -490; player.onGround = false; if(audioEnabled) try{ audios.jump && audios.jump.play(); }catch(e){} }

  // integrate
  let nextX = player.x + player.vx * dt;
  let nextY = player.y + player.vy * dt;

  // simple AABB collision with tiles
  // horizontal
  if(player.vx !== 0){
    const sign = player.vx > 0 ? 1 : -1;
    const probeX = sign>0 ? nextX + player.w : nextX;
    const leftTile = Math.floor(probeX / TILE);
    const topTile = Math.floor(player.y / TILE);
    const bottomTile = Math.floor((player.y + player.h - 1) / TILE);
    let collided = false;
    for(let ty=topTile; ty<=bottomTile; ty++){
      if(isSolidTile(leftTile, ty)){ collided = true; break; }
    }
    if(collided) player.vx = 0;
    else player.x = nextX;
  }

  // vertical
  const probeY = player.vy > 0 ? nextY + player.h : nextY;
  const topTile2 = Math.floor(probeY / TILE);
  const leftTile2 = Math.floor(player.x / TILE);
  const rightTile2 = Math.floor((player.x + player.w - 1) / TILE);
  let collidedV = false;
  for(let tx=leftTile2; tx<=rightTile2; tx++){
    if(isSolidTile(tx, topTile2)){ collidedV = true; break; }
  }
  if(collidedV){
    if(player.vy > 0){ // landing
      player.onGround = true;
    }
    player.vy = 0;
  } else {
    player.y = nextY;
    player.onGround = false;
  }

  // keep player within world bounds horizontally
  if(player.x < 0) player.x = 0;
  if(player.x + player.w > WORLD_W*TILE) player.x = WORLD_W*TILE - player.w;

  // day/night update
  updateDayNight(dt);

  updateCamera();

  // interactions with mouse: placing (LMB) and breaking (RMB)
  handleMouseInteractions();
}

/* ======= –ú–´–®–¨: –ª–æ–º–∞–Ω–∏–µ/–ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ ======= */
let lastBreakTime = 0;
function handleMouseInteractions(){
  if(mouse.down){
    // place block if selected slot has block
    const rect = canvas.getBoundingClientRect();
    const worldX = cameraX + mouse.x;
    const worldY = cameraY + mouse.y;
    const {tx, ty} = pixelToTile(worldX, worldY);
    const px = player.x + player.w/2, py = player.y + player.h/2;
    const dist = Math.hypot((tx*TILE+TILE/2)-px, (ty*TILE+TILE/2)-py);
    if(dist <= PLACE_DIST){
      const slot = hotbar[selectedSlot];
      if(slot && slot.id !== null){
        // place only if target is air and tile below not air (no floating)
        if(tx>=0 && tx<WORLD_W && ty>=0 && ty<WORLD_H && world[tx][ty]===TILE_AIR){
          // only place if at least one adjacent tile exists (prevent floating) or placing on ground
          const below = (ty+1 < WORLD_H) ? world[tx][ty+1] : TILE_STONE;
          const leftAdj = (tx-1 >= 0) ? world[tx-1][ty] : TILE_AIR;
          const rightAdj = (tx+1 < WORLD_W) ? world[tx+1][ty] : TILE_AIR;
          if(below !== TILE_AIR || leftAdj !== TILE_AIR || rightAdj !== TILE_AIR){
            if(slot.id === TILE_TORCH){ world[tx][ty] = TILE_TORCH; }
            else world[tx][ty] = slot.id;
            useFromSelected();
            mouse.down = false; // single place per click
          }
        }
      }
    }
  }
  if(mouse.rightDown){
    // break target
    const rect = canvas.getBoundingClientRect();
    const worldX = cameraX + mouse.x;
    const worldY = cameraY + mouse.y;
    const {tx, ty} = pixelToTile(worldX, worldY);
    const px = player.x + player.w/2, py = player.y + player.h/2;
    const dist = Math.hypot((tx*TILE+TILE/2)-px, (ty*TILE+TILE/2)-py);
    const now = performance.now();
    if(dist <= BREAK_DIST && now - lastBreakTime > 150){
      if(tx>=0 && tx<WORLD_W && ty>=0 && ty<WORLD_H){
        const tile = world[tx][ty];
        if(tile !== TILE_AIR){
          // drop logic: try add to inventory, otherwise remove
          const added = addToInventory(tile, 1);
          world[tx][ty] = TILE_AIR;
          if(audioEnabled) try{ audios.break && audios.break.play(); }catch(e){}
        }
      }
      lastBreakTime = now;
    }
    // single break per click:
    mouse.rightDown = false;
  }
}

/* ======= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======= */
function init(){
  resizeCanvas();
  generateWorld();
  placePlayerOnSurface();
  renderInventory();
  updateCraftMenu();
  // event handlers
  helpBtn.addEventListener('click', ()=>{ helpDiv.style.display = helpDiv.style.display==='none'?'block':'none'; });
  audioBtn.addEventListener('click', ()=>{ audioEnabled = !audioEnabled; audioBtn.textContent = audioEnabled ? 'üîä –ó–≤—É–∫' : 'üîá –ë–µ–∑ –∑–≤—É–∫–∞'; if(audioEnabled){ try{ audios.bgm && audios.bgm.play().catch(()=>{});}catch(e){} } else{ try{ audios.bgm && audios.bgm.pause(); }catch(e){} } });
  // start bgm if allowed
  try{ if(audioEnabled) audios.bgm && audios.bgm.play().catch(()=>{}); }catch(e){}
  lastTime = performance.now();
  requestAnimationFrame(loop);
}

/* ======= –ó–ê–ü–£–°–ö –ó–ê–ì–†–£–ó–ö–ò ======= */
loadAssets(()=>{ init(); });

</script>
</body>
</html>